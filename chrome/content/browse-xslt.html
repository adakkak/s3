<?xml version="1.0"?>
<!--
     Copyright Jesse Andrews, 2005-2008
     http://overstimulate.com

     This file may be used under the terms of of the
     GNU General Public License Version 2 or later (the "GPL"),
     http://www.gnu.org/licenses/gpl.html

     Software distributed under the License is distributed on an "AS IS" basis,
     WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
     for the specific language governing rights and limitations under the
     License.
-->

<?xml-stylesheet href="chrome://global/skin/" type="text/css"?>
<?xml-stylesheet type="text/css" href="chrome://s3/skin/style.css"?>

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script type="application/x-javascript" src="chrome://global/content/nsDragAndDrop.js"></script>
    <script type="application/x-javascript" src="chrome://s3/content/sha1.js"></script>
    <script type="application/x-javascript" src="chrome://s3/content/S3Ajax.js"></script>
    <script type="application/x-javascript" src="chrome://s3/content/dnd.js"></script>
    <script type="application/x-javascript" src="chrome://s3/content/vendor/jquery-1.2.3.min.js"></script>
    <script type="application/x-javascript" src="chrome://s3/content/vendor/jquery.blockUI.js"></script>
    <script type="application/x-javascript">

      var Cc = Components.classes;
      var Ci = Components.interfaces;
      const PREFS = Cc['@mozilla.org/preferences-service;1']
                      .getService(Ci.nsIPrefService)
                      .getBranch('extension.s3.');

      const mimeSVC = Cc['@mozilla.org/mime;1']
                        .getService(Ci.nsIMIMEService);

      var bucket, prefix;
      var xslt = new XSLTProcessor();

      var dropListener = {
        handleEvent: function(event) {
          nsDragAndDrop.drop(event, dnd);
        }
      }

      var fm = {
        init: function() {
          document.addEventListener('dragdrop', dropListener, true);
          document.getElementById('location').innerHTML = document.title = window.location.href;

          try {
            S3Ajax.KEY_ID = PREFS.getCharPref('key');
            S3Ajax.SECRET_KEY = PREFS.getCharPref('secret_key');
            document.body.removeAttribute("unauth");
          } catch (e) {
            // if the keys aren't set proceed without them
            // S3Ajax will do anonymous calls
            document.body.setAttribute("unauth", true);
          }

          var req = new XMLHttpRequest();
          req.open("GET", "chrome://s3/content/keys.xsl", false);
          req.send(null);

          xslt.importStylesheet(req.responseXML);

          bucket = window.location.host;
          prefix = unescape(window.location.pathname.slice(1));
          fm.listKeys();
        },

        listKeys: function() {
          $.blockUI('<h3><img src="chrome://s3/skin/spinner.gif" /> refreshing key list</h3>');
          S3Ajax.listKeys(bucket,
            {prefix: prefix, delimiter: '/'},
            function (req) {
              var keylist = $('#keylist')[0];
              if (keylist) {
                keylist.parentNode.removeChild(keylist);
              }
              var fragment = xslt.transformToFragment(req.responseXML, document);
              document.body.appendChild(fragment);
              $.unblockUI();
            });
        },

        delete: function(keyObj) {
          S3Ajax.deleteKey( bucket, keyObj.getAttribute('key'), function() {
            keyObj.parentNode.parentNode.parentNode.removeChild( keyObj.parentNode.parentNode );
          });
        },

        upload: function() {
          var picker = Components.classes["@mozilla.org/filepicker;1"]
            .createInstance(Components.interfaces.nsIFilePicker);

          picker.init(window, 'Choose file(s) to upload to S3', Components.interfaces.nsIFilePicker.modeOpenMultiple);

          if (picker.show() == Components.interfaces.nsIFilePicker.returnOK) {
            var enum = picker.files;
            while (enum.hasMoreElements()) {
              var file = enum.getNext();
              file.QueryInterface(Components.interfaces.nsIFile);
              Uploader.add(bucket, file);
            }
          }
        }
      }

      S3Ajax.upload = function(bucket, key, file, cb) {
        var params = {};
        try {
          params.content_type = mimeSVC.getTypeFromFile(file);
          // TODO: if this fails, we should do our own lookup ... instead of just defaulting to text/plain
        } catch(e) {};
        var tmpInputStream = Cc["@mozilla.org/network/file-input-stream;1"].createInstance(Ci.nsIFileInputStream);
        tmpInputStream.init(file, 1, 0644, 0);
        var tmpInputBufferStream = Cc["@mozilla.org/network/buffered-input-stream;1"].createInstance(Ci.nsIBufferedInputStream);
        tmpInputBufferStream.init(tmpInputStream, 65536 * 4);
        S3Ajax.put(bucket, key, tmpInputBufferStream, params, function() {
          cb();
        });
      }

      var Uploader = {
        working: false,
        queue: [],
        add: function(bucket, file) {
          var key = escape(prefix + file.leafName);
          Uploader.queue.push([bucket, key, file]);
          $('#queue_size').html(Uploader.queue.length + ' remaining in queue.');
          if (!Uploader.working) {
            Uploader.upload();
          }
        },
        upload: function() {
          Uploader.working = true;
          var cur = Uploader.queue.shift();
          var status = '<h3><img src="chrome://s3/skin/spinner.gif" /> uploading...</h3>' +
            '<h6>' + cur[1] + '</h6>' +
            '<p id="queue_size">';
          if (Uploader.queue.length > 0) {
            status += Uploader.queue.length + ' remaining in queue.'
          }
          status += '</p>'
          $.blockUI(status);
          S3Ajax.upload(cur[0], cur[1], cur[2], Uploader.uploadComplete);
        },
        uploadComplete: function() {
          if (Uploader.queue.length > 0) {
            Uploader.upload();
          }
          else {
            Uploader.working = false;
            $.unblockUI();
            fm.listKeys();
          }
        }
      }

      window.onload = fm.init;
    </script>
    <style>
      body {
        background: #eee;
        padding: 20px;
      }

      body[unauth] .delete_button{
        display: none;
      }

      table {
        padding: 20px;
        margin-top: 10px;
        background: #fff;
        -moz-border-radius: 10px;
        border: 1px solid #ddd;
        width: 100%;
      }

      #keylist td {
        padding: 3px 0;
      }

      #keylist tr:hover {
        background-color:#f8f8f8;
      }

      .upload_label {
        font-weight: bold;
      }

      .upload_box {
        position: absolute;
        top: 20px;
        padding: 10px;
        right: 20px;
      }

      .upload_box input {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2 id="location"></h2>
    <div class="delete_button upload_box">
      <input type="button" id="upload_button" onclick="fm.upload()" value=" Upload "/>
    </div>
  </div>
  </body>
</html>
