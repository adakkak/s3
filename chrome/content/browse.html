<html><head><title>File Manager</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <script type="text/javascript" src="chrome://s3/content/S3Ajax.js"></script>
  <script language="javascript">

  var $ = function(id) {
    return document.getElementById(id);
  }
  
  var growl = function( msg ) {
    var div = document.createElement( 'div' )
    div.setAttribute('style', 'font-size: 2em; position: absolute; top: 10px; right: 10px; border: 1px solid #333; background: #fe9; padding: 3px; opacity: 0.75; text-align: right');
    div.innerHTML = msg;
    document.body.appendChild( div );
    setTimeout( function() {
      document.body.removeChild( div );
    }, 2000);
  }
  
  var fm = {
    bucket: 'rww',
    prefix: '',
    init: function() {
      this.bucket = window.location.href.split('/')[2];
      this.prefix = window.location.href.slice(6+this.bucket.length);
      this.list();
    },
    addKey: function( item ) {
      var key = item.Key;
      if ($(key)) return;
      var tr=document.createElement('tr');
      tr.setAttribute('id', key);

      var td=document.createElement('td');
      var a=document.createElement('a');
      var label = key.split('/');
      label = label[label.length-1];
      a.appendChild( document.createTextNode( label ));
      a.href = '//' + fm.bucket + '/' + key;
      td.appendChild( a );
      tr.appendChild( td );

      var td=document.createElement('td');
      td.appendChild( document.createTextNode( item.LastModified ) );
      tr.appendChild( td );

      var td=document.createElement('td');
      td.appendChild( document.createTextNode( item.Size ) );
      tr.appendChild( td );

      var td=document.createElement('td');
      td.setAttribute('class', 'actions');

      var a=document.createElement('a');
      a.appendChild( document.createTextNode( 'delete' ));
      a.onclick = function() { if (confirm('About to deleting ' + key)) { fm.delete( this.parentNode.parentNode.id ); } return false; }
      a.href = "#";
      td.appendChild( a );

      tr.appendChild( td );

      $('keys').appendChild( tr );
    },
    addDir: function( item ) {
      if (item) {
        var key = item.Prefix;
        var label = key;
      } 
      else {
        var key = '';
        var label = '..'
      }

      var tr=document.createElement('tr');
      tr.setAttribute('id', key);

      var td=document.createElement('td');
      var a=document.createElement('a');
      a.appendChild( document.createTextNode( label ));
      a.href = '//' + fm.bucket + '/' + key;
      td.appendChild( a );
      tr.appendChild( td );

      $('keys').appendChild( tr );
    },
    chdir: function( prefix ) {
      this.prefix = prefix;
      this.list();
    },
    delete: function(key) {
      S3Ajax.deleteKey( fm.bucket, key, function() {
        $(key).parentNode.removeChild( $(key) )
      } );
    },
    clear: function() {
      $('keys').parentNode.removeChild( $('keys') );
    },
    list: function() {
      while ($('files').hasChildNodes()) 
        $('files').removeChild( $('files').lastChild );

      var table = document.createElement('table');
      table.setAttribute('id', 'keys');
      var tr = document.createElement('tr');
      var th = document.createElement('th');
      th.appendChild( document.createTextNode('Key') );
      tr.appendChild( th );
      var th = document.createElement('th');
      th.appendChild( document.createTextNode('Last Modified') );
      tr.appendChild( th );
      var th = document.createElement('th');
      th.appendChild( document.createTextNode('Size') );
      tr.appendChild( th );
      var th = document.createElement('th');
      th.appendChild( document.createTextNode('Actions') );
      tr.appendChild( th );
      
      table.appendChild(tr);
      $('files').appendChild( table );

      if (this.prefix.length) 
        this.addDir();
        
      document.title = 'Index of S3 ' + this.bucket + '/' + this.prefix;

      S3Ajax.listKeys(this.bucket, {prefix: this.prefix, delimiter: '/'},
        function(req, obj) {
          var prefixes = obj.ListBucketResult.CommonPrefixes;
          if (prefixes) {
            if (prefixes.Prefix) {
              fm.addDir(prefixes);
            }
            else {
              for (var i=0, item; item=prefixes[i]; i++) {
                fm.addDir(item);
              }
            }
          }

          var contents = obj.ListBucketResult.Contents;
          if (contents) {
            for (var i=0, item; item=contents[i]; i++) {
              fm.addKey(item);
            }
          }
      },
      function(req, obj) {
        growl('Error loading keys');
      });
    },
  }

  window.onload = function() {fm.init();};

  </script>
  <style type="text/css"> 
body {
  padding: 10px 20px;
  background: #eee;
  font-family: Arial, Helvetica, sans-serif;
  font-size: 10px;
}

table {
  width: 100%;
}

tr th {
  text-align: left;
}

tr:hover td {
  background: #eee;
}

td.actions a {
  padding: 0 4px;
  border: 1px solid #888;
  margin: 2px;
  text-decoration: none;
  color: #08f;
  background: #fff;
}

td.actions a:hover {
  color: #f00;
  border-color: black;
}
#files {
  background: #fff;
  padding: 5px 10px;
  -moz-border-radius: 10px;
  border: 1px solid #ddd;
}
  </style>

  </head><body>

  <div id="files"></div>  

</body></html>
