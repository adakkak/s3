<?xml version="1.0"?>
<!--
     Copyright Jesse Andrews, 2005-2008
     http://overstimulate.com

     This file may be used under the terms of of the
     GNU General Public License Version 2 or later (the "GPL"),
     http://www.gnu.org/licenses/gpl.html

     Software distributed under the License is distributed on an "AS IS" basis,
     WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
     for the specific language governing rights and limitations under the
     License.
-->

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
  <head>
    <link rel="stylesheet" href="chrome://s3/skin/style.css" />
    <link rel="stylesheet" href="chrome://s3/content/vendor/humanmsg.css" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script type="application/x-javascript" src="chrome://global/content/nsDragAndDrop.js"></script>
    <script type="application/x-javascript" src="chrome://s3/content/sha1.js"></script>
    <script type="application/x-javascript" src="chrome://s3/content/S3Ajax.js"></script>
    <script type="application/x-javascript" src="chrome://s3/content/dnd.js"></script>
    <script type="application/x-javascript" src="chrome://s3/content/vendor/jquery-1.2.3.min.js"></script>
    <script type="application/x-javascript" src="chrome://s3/content/vendor/jquery.blockUI.js"></script>
    <script type="application/x-javascript" src="chrome://s3/content/vendor/jquery.easing.js"></script>
    <script type="application/x-javascript" src="chrome://s3/content/vendor/humanmsg.js"></script>
    <script type="application/x-javascript">

      var Cc = Components.classes;
      var Ci = Components.interfaces;
      const PREFS = Cc['@mozilla.org/preferences-service;1']
                      .getService(Ci.nsIPrefService)
                      .getBranch('extension.s3.');

      const mimeSVC = Cc['@mozilla.org/mime;1']
                        .getService(Ci.nsIMIMEService);

      var bucket, prefix;
      var xslt = new XSLTProcessor();

      var dropListener = {
        handleEvent: function(event) {
          nsDragAndDrop.drop(event, dnd);
        }
      }

      var fm = {
        init: function() {
          document.addEventListener('dragdrop', dropListener, true);
          document.title = window.location.href;
          
          $('.upload').click(function() {
            fm.upload();
            return false;
          })

          try {
            S3Ajax.KEY_ID = PREFS.getCharPref('key');
            S3Ajax.SECRET_KEY = PREFS.getCharPref('secret_key');
            document.body.removeAttribute("unauth");
          } catch (e) {
            // if the keys aren't set proceed without them
            // S3Ajax will do anonymous calls
            document.body.setAttribute("unauth", true);
          }

          var req = new XMLHttpRequest();
          req.open("GET", "chrome://s3/content/keys.xsl", false);
          req.send(null);

          xslt.importStylesheet(req.responseXML);

          bucket = window.location.host;
          prefix = unescape(window.location.pathname.slice(1));
          $('#location').html("<a href='s3://'>s3</a>://<a href='s3://"+bucket+"'>"+bucket+"</a>/"+prefix)
          fm.listKeys();
        },

        listKeys: function() {
          $('#active').addClass('busy')
          S3Ajax.listKeys(bucket,
            {prefix: prefix, delimiter: '/'},
            function (req) {
              var keylist = $('#keylist')[0];
              if (keylist) {
                keylist.parentNode.removeChild(keylist);
              }
              var fragment = xslt.transformToFragment(req.responseXML, document);
              $('#active')[0].appendChild(fragment);

              $('tr').hover(function() {
                var element = this;
                var key = this.getAttribute('key');
                var deleteButton = $('<a href="#" class="delete">delete<a>')
                deleteButton.click(function() {
                  if (confirm('Are you sure you want to delete:\n' + key + '?')) { 
                    fm.delete( key, element );
                  } 
                  return false;
                });
                $('.actions', this).append(deleteButton)
              }, function() {
                $('.actions', this).empty();
              })

              $('#active').removeClass('busy');
            }, function(req) {
              $('#active').removeClass('busy');
              humanMsg.displayMsg('Listing in <strong>' + bucket + '</strong>: ' +
                req.responseXML.getElementsByTagName('Message')[0].childNodes[0].textContent)
            });
        },

        delete: function(key, element) {
          S3Ajax.deleteKey( bucket, key, function() {
            $(element).remove();
          }, function(req) {
            humanMsg.displayMsg('Deletion in <strong>' + bucket + '</strong>: ' +
              req.responseXML.getElementsByTagName('Message')[0].childNodes[0].textContent)
          });
        },

        upload: function() {
          var picker = Components.classes["@mozilla.org/filepicker;1"]
            .createInstance(Components.interfaces.nsIFilePicker);

          picker.init(window, 'Choose file(s) to upload to S3', Components.interfaces.nsIFilePicker.modeOpenMultiple);

          if (picker.show() == Components.interfaces.nsIFilePicker.returnOK) {
            var enum = picker.files;
            while (enum.hasMoreElements()) {
              var file = enum.getNext();
              file.QueryInterface(Components.interfaces.nsIFile);
              Uploader.add(bucket, file);
            }
          }
        }
      }

      S3Ajax.upload = function(bucket, key, file, cb) {
        var params = {};
        try {
          params.content_type = mimeSVC.getTypeFromFile(file);
          // TODO: if this fails, we should do our own lookup ... instead of just defaulting to text/plain
        } catch(e) {};
        var tmpInputStream = Cc["@mozilla.org/network/file-input-stream;1"].createInstance(Ci.nsIFileInputStream);
        tmpInputStream.init(file, 1, 0644, 0);
        var tmpInputBufferStream = Cc["@mozilla.org/network/buffered-input-stream;1"].createInstance(Ci.nsIBufferedInputStream);
        tmpInputBufferStream.init(tmpInputStream, 65536 * 4);
        S3Ajax.put(bucket, key, tmpInputBufferStream, params, function() {
          cb();
        }, function(req) {
          humanMsg.displayMsg('Upload to <strong>' + bucket + '</strong>: ' +
            req.responseXML.getElementsByTagName('Message')[0].childNodes[0].textContent);
          cb();
        });
      }

      var Uploader = {
        working: false,
        queue: [],
        add: function(bucket, file) {
          var key = escape(prefix + file.leafName);
          Uploader.queue.push({bucket: bucket, key: key, file: file});
          $('#queue_size').html(Uploader.queue.length + ' remaining in queue.');
          if (!Uploader.working) {
            Uploader.upload();
          }
        },
        upload: function() {
          Uploader.working = true;
          var cur = Uploader.queue.shift();
          var status = '<h3><img src="chrome://s3/skin/spinner.gif" /> uploading...</h3>' +
            '<h6>' + cur.key + '</h6>' +
            '<p id="queue_size">';
          if (Uploader.queue.length > 0) {
            status += Uploader.queue.length + ' remaining in queue.'
          }
          status += '</p>'
          $.blockUI(status);
          S3Ajax.upload(cur.bucket, cur.key, cur.file, Uploader.uploadComplete);
        },
        uploadComplete: function() {
          if (Uploader.queue.length > 0) {
            Uploader.upload();
          }
          else {
            Uploader.working = false;
            $.unblockUI();
            fm.listKeys();
          }
        }
      }
      
      $(fm.init);
    </script>
  </head>
  <body>
    <h2 id="location"></h2>
    <div class="upload_box">
      <a href="#" class="upload">Upload</a>
    </div>

    <div id="active"></div>
  </body>
</html>
